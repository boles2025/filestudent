<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ø¯Ø§Ø±Ø© Ø´Ø¦ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    :root{
      --bg1:#051a19; --bg2:#0f3f38;
      --card:rgba(255,255,255,.08);
      --card-border:rgba(255,255,255,.16);
      --ink:#ffffff; --muted:#dfeff0;
      --accent:#19d1b8; --accent-2:#7bd7ff; --warn:#ffea00; --danger:#ff6b6b;
    }
    :root[data-theme="light"]{
      --bg1:#f8f9fa; --bg2:#e9ecef;
      --card:rgba(0,0,0,.05);
      --card-border:rgba(0,0,0,.125);
      --ink:#212529; --muted:#495057;
      --accent:#19d1b8; --accent-2:#7bd7ff; --warn:#ffea00; --danger:#ff6b6b;
    }
    @keyframes bg-shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    body{
      margin:0; min-height:100vh; color:var(--ink);
      font-family:"Tajawal",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      background-size:200% 200%; animation:bg-shift 22s ease-in-out infinite;
    }
    .container-xl{ max-width:1200px; }

    /* Header */
    .admin-header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:14px 0 6px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand img{
      width:56px; height:56px; border-radius:12px; object-fit:cover;
      box-shadow:0 10px 26px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
      background:#fff;
    }
    .brand h1{
      margin:0; font-size: clamp(18px,2.2vw,26px); font-weight:900; letter-spacing:.2px;
      text-shadow: 0 8px 26px rgba(0,0,0,.25);
    }
    .brand small{ color:var(--muted); opacity:.9 }

    .theme-toggle{
      background:var(--card);
      color:var(--ink);
      border:1px solid var(--card-border);
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
    }

    /* Cards */
    .cardx{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
      padding:16px;
    }
    .metric{
      display:flex; align-items:center; justify-content:center; gap:12px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.20);
      border-radius:14px; padding:14px;
    }
    .metric .label{ color:#d8f7f1; font-weight:700; }
    .metric .value{ font-weight:900; font-size: clamp(28px, 4.2vw, 46px); line-height:1; text-shadow:0 4px 16px rgba(0,0,0,.25); }
    .value.warn{ color:var(--warn); } .value.info{ color:var(--accent-2); }

    /* Tabs */
    .nav-pills .nav-link{
      color:#eafff8; font-weight:800; border-radius:12px; border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
    }
    .nav-pills .nav-link.active{
      background: linear-gradient(90deg,#22e0c5,#20b1d4);
      border-color: transparent; color:#06312d;
      box-shadow:0 10px 28px rgba(0,0,0,.25);
    }

    .form-control, .form-select{
      background: rgba(255,255,255,.07);
      color: var(--ink);
      border-color: rgba(255,255,255,.25);
    }
    .form-control::placeholder{ color: rgba(255,255,255,.65); }

    .btn-accent{
      color:#06332f; font-weight:900; border:none;
      background: linear-gradient(0deg, #9af5e7, #6cf1e0);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn-outline-light{ border-color:rgba(255,255,255,.6); color:#fff; }
    .btn-outline-danger{ border-color:rgba(255,0,0,.5); color:#ffb7b7; }
    .btn-success{ font-weight:800; }

    /* Footer ticker */
    .footer-ticker{
      position: fixed; left:0; right:0; bottom:0;
      background: rgba(0,0,0,.55);
      border-top: 1px solid rgba(255,255,255,.15);
      backdrop-filter: blur(6px);
      z-index: 50; overflow: hidden; white-space: nowrap;
    }
    .footer-ticker .inner{
      display:inline-block; padding:10px 0; animation: marquee 22s linear infinite;
      font-weight:800; color:#eafff8; text-shadow:0 0 10px rgba(25,209,184,.35);
    }
    .footer-ticker:hover .inner{ animation-play-state: paused; }
    @keyframes marquee { from{ transform: translateX(100%) } to{ transform: translateX(-100%) } }

    .input-group-text{ background:rgba(255,255,255,.08); color:#fff; border-color:rgba(255,255,255,.25); }

    /* Waiting List Styles */
    .waiting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(25, 209, 184, 0.1);
      border: 1px solid rgba(25, 209, 184, 0.3);
      border-radius: 12px;
      padding: 10px 14px;
      transition: all 0.2s ease;
    }
    .waiting-item:hover {
      background: rgba(25, 209, 184, 0.2);
      transform: translateY(-2px);
    }
    .waiting-number {
      font-size: 1.4rem;
      font-weight: bold;
      color: #19d1b8;
    }
    .delete-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .delete-btn:hover {
      background: #ff5252;
      transform: scale(1.05);
    }
  </style>
</head>
<body>

  <div class="container-xl py-3" style="padding-bottom:76px;">
    <!-- Header -->
    <div class="admin-header">
      <div class="brand">
        <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Ø´Ø¹Ø§Ø± ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ">
        <div>
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</h1>
          <small>Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù†ÙŠØ§ â€” Ù†Ø¸Ø§Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small>
        </div>
      </div>
      <div class="text-end d-flex align-items-center gap-2">
        <span class="badge rounded-pill" style="background:#0fd3bb; color:#08332f; font-weight:900;">ADM</span>
        <button id="themeToggle" class="theme-toggle" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±">â˜€ï¸</button>
      </div>
    </div>

    <!-- Overview metrics -->
    <div class="cardx mb-3">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <div class="metric">
            <div class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ø±ÙŠ</div>
            <div id="m_current" class="value warn">0</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="metric">
            <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ù„ÙŠ Ø§Ø®Ø°ÙˆØ§ Ø§Ø±Ù‚Ø§Ù… Ø­ØªÙŠ Ø§Ù„Ø§Ù† </div>
            <div id="m_issued" class="value">0</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="metric">
            <div class="label">Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙˆÙ† Ø§Ù„Ø¢Ù†  </div>
            <div id="m_waiting" class="value info">0</div>
          </div>
        </div>
      </div>
      <div class="small mt-2" style="color:#ccebe7" id="lastUpdate">â€”</div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-queue" data-bs-toggle="pill" data-bs-target="#pane-queue" type="button" role="tab">Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¯ÙˆØ±</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-ann" data-bs-toggle="pill" data-bs-target="#pane-ann" type="button" role="tab">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-waiting" data-bs-toggle="pill" data-bs-target="#pane-waiting" type="button" role="tab">Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙˆÙ†</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-settings" data-bs-toggle="pill" data-bs-target="#pane-settings" type="button" role="tab">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
      <!-- Queue Control -->
      <div class="tab-pane fade show active" id="pane-queue" role="tabpanel">
        <div class="cardx">
          <div class="d-flex flex-wrap gap-2 justify-content-center mb-3">
            <button id="btn_prev" class="btn btn-outline-light">Ø§Ù„Ø³Ø§Ø¨Ù‚ âˆ’1</button>
            <button id="btn_next" class="btn btn-accent">Ø§Ù„ØªØ§Ù„ÙŠ +1</button>
            <button id="btn_reset" class="btn btn-outline-danger">ØªØµÙÙŠØ± (Ø§Ù„Ø¬Ø§Ø±ÙŠ + Ø§Ù„Ù…ÙØµØ¯Ø±)</button>
          </div>
          <div class="row g-2 align-items-center">
            <div class="col-7">
              <input id="setInput" type="number" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ù…Ø¹ÙŠÙ‘Ù†Ù‹Ø§ Ù„Ù„Ø¬Ø§Ø±ÙŠ">
            </div>
            <div class="col-5 d-grid">
              <button id="btn_set" class="btn btn-outline-light">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ø±ÙŠ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Announcements -->
      <div class="tab-pane fade" id="pane-ann" role="tabpanel">
        <div class="cardx">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (ÙŠÙ…ÙƒÙ† Ø§Ù„ÙØµÙ„ Ø¨Ù€ | Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§)</label>
              <textarea id="annText" class="form-control" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø­Ø¶Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© | Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ 9-2"></textarea>
            </div>

            <div class="col-12 d-flex gap-2">
              <button id="saveTextBtn" class="btn btn-accent flex-fill">Ø­ÙØ¸ ÙƒÙ†Øµ ÙˆØ§Ø­Ø¯</button>
              <button id="parseToListBtn" class="btn btn-outline-light flex-fill">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø©</button>
            </div>

            <div class="col-12">
              <label class="form-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</label>
              <div id="annList" class="vstack gap-2"></div>
              <div class="d-flex gap-2 mt-2">
                <button id="addItemBtn" class="btn btn-outline-light">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
                <button id="saveListBtn" class="btn btn-success ms-auto">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Waiting List -->
      <div class="tab-pane fade" id="pane-waiting" role="tabpanel">
        <div class="cardx">
          <h5 class="mb-3 text-center text-info">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙˆÙ†</h5>
          <div id="waitingListContainer" class="vstack gap-2">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
          </div>
          <div class="text-center mt-3">
            <small class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø±Ù‚Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø­Ø°Ù"</small>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="tab-pane fade" id="pane-settings" role="tabpanel">
        <div class="cardx">
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <label class="form-label">Ø³Ø±Ø¹Ø© Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ â€” Ø£Ù‚Ù„ = Ø£Ø³Ø±Ø¹)</label>
              <div class="input-group">
                <span class="input-group-text">Ø§Ù„Ù…Ø¯Ø©</span>
                <input id="tickerSeconds" type="number" class="form-control" min="8" max="120" step="1" value="28">
                <span class="input-group-text">Ø«Ø§Ù†ÙŠØ©</span>
                <button id="saveSpeedBtn" class="btn btn-accent">Ø­ÙØ¸</button>
              </div>
              <div class="form-text text-light mt-1">Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙØ­ÙØ¸ ÙÙŠ <code>settings/tickerBaseDuration</code> ÙˆØªØ·Ø¨ÙÙ‘Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶.</div>
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">ØªØ¬Ø±Ø¨Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø³Ø±Ø¹Ø©</label>
              <div class="border rounded p-2" style="background:rgba(0,0,0,.25);">
                <div id="demoTicker" style="white-space:nowrap; overflow:hidden;">
                  <div id="demoInner" style="display:inline-block; padding:6px 0;">
                    <span class="me-4">â€” Ø´Ø±ÙŠØ· ØªØ¬Ø±ÙŠØ¨ÙŠ â€”</span>
                    <span class="me-4">Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ 9 Øµ Ø¥Ù„Ù‰ 2 Ù…</span>
                    <span class="me-4">ÙŠØ±Ø¬Ù‰ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</span>
                    <span>Ø´ÙƒØ±Ù‹Ø§ Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ…</span>
                  </div>
                </div>
              </div>
              <div class="small mt-1">Ø§Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø«Ù… Ø§Ø¶ØºØ· Â«Ø­ÙØ¸Â»ØŒ ÙˆØ´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø³ØªÙ„ØªÙ‚Ø· Ø§Ù„ØªØºÙŠÙŠØ±.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /container -->

  <!-- Footer ticker -->
  <div class="footer-ticker">
    <div class="inner">
      &nbsp;&nbsp;ØªØµÙ…ÙŠÙ… Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± â€” Ù…Ø¯ÙŠØ± ÙˆØ­Ø¯Ø© ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù†ÙŠØ§&nbsp;&nbsp;â€¢&nbsp;&nbsp;
      ØªØµÙ…ÙŠÙ… Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± â€” Ù…Ø¯ÙŠØ± ÙˆØ­Ø¯Ø© ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù†ÙŠØ§&nbsp;&nbsp;â€¢&nbsp;&nbsp;
      ØªØµÙ…ÙŠÙ… Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± â€” Ù…Ø¯ÙŠØ± ÙˆØ­Ø¯Ø© ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù†ÙŠØ§
    </div>
  </div>

  <!-- Firebase config -->
  <script src="js/firebase.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      root.setAttribute('data-theme', 'light');
      themeBtn.textContent = 'ğŸŒ™';
    }
    themeBtn.addEventListener('click', () => {
      const isLight = root.getAttribute('data-theme') === 'light';
      if (isLight) {
        root.removeAttribute('data-theme');
        localStorage.removeItem('theme');
        themeBtn.textContent = 'â˜€ï¸';
      } else {
        root.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        themeBtn.textContent = 'ğŸŒ™';
      }
    });
    // Ù…Ø±Ø§Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const qRef       = db.ref('queue');
    const currentRef = qRef.child('currentNumber');
    const issuedRef  = qRef.child('lastIssuedNumber');
    const annRef     = db.ref('announcements');
    const settingsRef= db.ref('settings');

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø±Ø¶
    const mCurrent = document.getElementById('m_current');
    const mIssued  = document.getElementById('m_issued');
    const mWait    = document.getElementById('m_waiting');
    const lastUpdateEl = document.getElementById('lastUpdate');
    let currentVal = 0, issuedVal = 0;

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ†
    function renderWaiting(){
      const waitingCount = Math.max(0, Number(issuedVal) - Number(currentVal));
      mWait.textContent = waitingCount;
      renderWaitingList();
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
    currentRef.on('value', s => {
      currentVal = Number(s.val() || 0);
      mCurrent.textContent = currentVal;
      lastUpdateEl.textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date().toLocaleString('ar-EG');
      renderWaiting();
    });
    issuedRef.on('value', s => {
      issuedVal = Number(s.val() || 0);
      mIssued.textContent = issuedVal;
      renderWaiting();
    });

    // Queue Controls
    document.getElementById('btn_prev').addEventListener('click', async () => {
      const nextVal = (Number(currentVal) || 0) - 1;
      await currentRef.set(nextVal < 0 ? 0 : nextVal);
    });
    document.getElementById('btn_next').addEventListener('click', async () => {
      if (Number(currentVal) >= Number(issuedVal)) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¸Ø±ÙˆÙ† Ø¬Ø¯Ø¯ â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ®Ø·Ù‘ÙŠ Ø¢Ø®Ø± Ø±Ù‚Ù… Ù…ÙØµØ¯Ø±.'); return; }
      const [c,i] = await Promise.all([currentRef.get(), issuedRef.get()]);
      const cur=Number(c.val()||0), iss=Number(i.val()||0);
      if (cur >= iss) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¸Ø±ÙˆÙ† Ø¬Ø¯Ø¯ Ø§Ù„Ø¢Ù†.');
      await currentRef.set(cur+1);
    });
    document.getElementById('btn_reset').addEventListener('click', async () => {
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙÙŠØ±ØŸ Ø³ÙŠÙØµÙÙ‘Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ø±ÙŠ ÙˆØ¢Ø®Ø± Ø±Ù‚Ù… Ù…ÙØµØ¯Ø±.')) return;
      await qRef.update({ currentNumber: 0, lastIssuedNumber: 0 });
    });
    document.getElementById('btn_set').addEventListener('click', async () => {
      const n = Number(document.getElementById('setInput').value);
      if (!Number.isFinite(n) || n < 0) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ (>= 0)');
      const iss = Number((await issuedRef.get()).val() || 0);
      if (n > iss && !confirm('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙØ¯Ø®Ù„ Ø£ÙƒØ¨Ø± Ù…Ù† Ø¢Ø®Ø± Ù…ÙØµØ¯Ø±. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
      await currentRef.set(n);
    });

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ†
    const waitingListContainer = document.getElementById('waitingListContainer');

    function renderWaitingList() {
      waitingListContainer.innerHTML = '';
      const start = currentVal + 1;
      const end = issuedVal;

      if (start > end) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'text-center text-muted py-3';
        emptyMsg.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø§Ù„ÙŠÙ‹Ø§.';
        waitingListContainer.appendChild(emptyMsg);
        return;
      }

      for (let num = start; num <= end; num++) {
        const item = document.createElement('div');
        item.className = 'waiting-item';
        item.innerHTML = `
          <span class="waiting-number">${num}</span>
          <button class="delete-btn" data-num="${num}">Ø­Ø°Ù</button>
        `;
        waitingListContainer.appendChild(item);
      }

      // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø°Ù
      waitingListContainer.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const num = Number(e.target.getAttribute('data-num'));
          if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø±Ù‚Ù… ${num} Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŸ`)) return;

          // Ù†Ù‚ÙˆÙ… Ø¨ØªÙ‚Ù„ÙŠÙ„ lastIssuedNumber Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ø£Ø®ÙŠØ±
          if (num === issuedVal) {
            await issuedRef.set(num - 1);
          } else {
            alert('ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£Ø®ÙŠØ±. ÙŠÙÙ…ÙƒÙ†Ùƒ ØªØ®Ø·ÙŠÙ‡Ù… Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ§Ù„ÙŠ.');
          }
        });
      });
    }

    // Announcements (ÙƒÙ…Ø§ Ù‡Ùˆ)
    const annText = document.getElementById('annText');
    const annList = document.getElementById('annList');
    const addItemBtn = document.getElementById('addItemBtn');
    const saveTextBtn = document.getElementById('saveTextBtn');
    const parseBtn = document.getElementById('parseToListBtn');
    const saveListBtn = document.getElementById('saveListBtn');

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '<', '>': '>', '"': '&quot;', "'": '&#39;'
      })[m]);
    }

    function renderList(items) {
      annList.innerHTML = '';
      items.forEach((txt, i) => {
        const row = document.createElement('div');
        row.className = 'input-group';
        row.innerHTML = `
          <span class="input-group-text">${i + 1}</span>
          <input class="form-control ann-item" value="${escapeHtml(txt)}" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
          <button class="btn btn-outline-danger remove-btn" title="Ø­Ø°Ù">Ø­Ø°Ù</button>`;
        annList.appendChild(row);
      });
      updateIndexes();
    }

    function updateIndexes() {
      [...annList.querySelectorAll('.input-group-text')].forEach((el, idx) => el.textContent = (idx + 1));
    }

    annRef.on('value', s => {
      const data = s.val();
      let items = [];
      if (Array.isArray(data)) items = data.filter(Boolean);
      else if (typeof data === 'string') {
        annText.value = data;
        items = data.split('|').map(t => t.trim()).filter(Boolean);
      } else if (data && typeof data === 'object') items = Object.values(data).filter(Boolean);
      renderList(items);
    });

    addItemBtn.addEventListener('click', () => {
      const row = document.createElement('div');
      row.className = 'input-group';
      row.innerHTML = `
        <span class="input-group-text">${annList.children.length + 1}</span>
        <input class="form-control ann-item" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
        <button class="btn btn-outline-danger remove-btn" title="Ø­Ø°Ù">Ø­Ø°Ù</button>`;
      annList.appendChild(row);
      updateIndexes();
    });

    annList.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-btn')) {
        e.target.closest('.input-group').remove();
        updateIndexes();
      }
    });

    saveTextBtn.addEventListener('click', async () => {
      await annRef.set((annText.value || '').trim());
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙƒÙ†Øµ ÙˆØ§Ø­Ø¯.');
    });

    parseBtn.addEventListener('click', () => {
      const parts = (annText.value || '').split('|').map(s => s.trim()).filter(Boolean);
      renderList(parts);
    });

    saveListBtn.addEventListener('click', async () => {
      const items = [...annList.querySelectorAll('.ann-item')].map(i => i.value.trim()).filter(Boolean);
      await annRef.set(items);
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙƒÙ‚Ø§Ø¦Ù…Ø©.');
    });

    // Settings: ticker speed
    const tickerSecondsInp = document.getElementById('tickerSeconds');
    const saveSpeedBtn = document.getElementById('saveSpeedBtn');
    const demoTicker = document.getElementById('demoTicker');
    const demoInner = document.getElementById('demoInner');

    settingsRef.child('tickerBaseDuration').on('value', s => {
      const v = Number(s.val() || 28);
      tickerSecondsInp.value = v;
      applyDemoSpeed(v);
    });

    function applyDemoSpeed(sec) {
      demoTicker.style.position = 'relative';
      demoTicker.style.height = '32px';
      let start = null;
      const total = sec * 1000;
      function step(ts) {
        if (!start) start = ts;
        const prog = (ts - start) / total;
        const w = demoInner.scrollWidth + demoTicker.clientWidth;
        demoInner.style.transform = `translateX(${(1 - (prog % 1)) * 100}%)`;
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    saveSpeedBtn.addEventListener('click', async () => {
      const v = Number(tickerSecondsInp.value);
      if (!Number.isFinite(v) || v < 8 || v > 120) return alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø¨ÙŠÙ† 8 Ùˆ 120 Ø«Ø§Ù†ÙŠØ©.');
      await settingsRef.update({ tickerBaseDuration: v });
      alert('ØªÙ… Ø­ÙØ¸ Ø³Ø±Ø¹Ø© Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.');
    });
  </script>
</body>
</html>
