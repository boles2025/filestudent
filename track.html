<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تتبُّع الدور - كلية الطب البيطري</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    :root{
      --bg1:#051a19; --bg2:#0f3f38; --ink:#fff; --muted:#dfeff0;
      --accent1:#ffeb3b; --accent2:#00e5ff; --accent3:#ff4081; --ok:#2ecc71;
      --card:rgba(255,255,255,.08); --card-border:rgba(255,255,255,.16);
    }
    @keyframes bg-shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    body{
      margin:0; min-height:100vh; color:var(--ink);
      font-family:"Tajawal",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2)); background-size:200% 200%;
      animation:bg-shift 22s ease-in-out infinite; display:flex; flex-direction:column;
    }
    .container-xl{ max-width:900px; padding-bottom:76px; flex:1 0 auto; }

    .admin-header{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0 6px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ width:56px; height:56px; border-radius:12px; object-fit:cover; background:#fff; box-shadow:0 10px 26px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.25); }
    .brand h1{ margin:0; font-size:clamp(18px,2.2vw,26px); font-weight:900; text-shadow:0 8px 26px rgba(0,0,0,.25); }
    .brand small{ color:var(--muted); opacity:.9 }

    .cardx{ background:var(--card); border:1px solid var(--card-border); border-radius:18px; box-shadow:0 18px 40px rgba(0,0,0,.25); padding:16px; margin-bottom:14px; }

    /* خانة رقم الطالب (بيضاوية متحركة لطيفة) */
    .pill{ display:inline-flex; align-items:center; gap:10px; padding:10px 18px; border-radius:999px;
      background: linear-gradient(90deg, #ffffff, #fff9c4, #ffffff); color:#0b3d3a; font-weight:900;
      box-shadow:0 10px 24px rgba(0,0,0,.20), inset 0 -3px 0 rgba(0,0,0,.08); position:relative; overflow:hidden; }
    .pill::after{ content:""; position:absolute; top:0; bottom:0; width:60px; left:-60px;
      background:linear-gradient(100deg, rgba(255,255,255,0), rgba(255,255,255,.65), rgba(255,255,255,0)); transform:skewX(-20deg);
      animation: shine 2.8s linear infinite; }
    @keyframes shine { 0%{ left:-70px } 100%{ left:110% } }
    .pill .label{ opacity:.7; font-weight:700; } .pill .value{ font-size: clamp(22px, 3.8vw, 32px); line-height:1; }

    /* الرقم الجاري */
    .big-num{ font-size: clamp(60px, 14vw, 140px); line-height:.9; font-weight:900; text-align:center; letter-spacing:-1px; margin:6px 0 8px;
      background: conic-gradient(from var(--angle), #fff, var(--accent1), #fff, var(--accent2), #fff, var(--accent3), #fff);
      -webkit-background-clip:text; background-clip:text; color:transparent; --angle:0deg; animation: hueRotate 10s linear infinite; text-shadow: 0 0 20px rgba(0,0,0,.25); }
    @keyframes hueRotate { 0%{ filter:hue-rotate(0deg); --angle:0deg } 100%{ filter:hue-rotate(360deg); --angle:360deg } }
    .title-muted{ opacity:.85; font-weight:700; text-align:center; }

    /* المتبقي */
    .remain-card{ transition: background .25s ease, box-shadow .25s ease, transform .2s ease; }
    .remain-num{ font-size: clamp(34px, 9vw, 72px); font-weight:900; text-align:center; margin:2px 0 0; color:#fff; text-shadow: 0 0 14px rgba(0,0,0,.25); }
    .remain-card.zero{ background: rgba(46, 204, 113, .18); box-shadow: 0 0 0 2px rgba(46, 204, 113, .45) inset, 0 10px 24px rgba(0,0,0,.18); transform: translateY(-2px); }
    .remain-card.zero .title-muted{ color:#d6ffe8; } .remain-card.zero .remain-num{ color:#d6ffe8; text-shadow:none; }

    /* شريط الإعلانات */
    .ticker-wrap{ width:100%; background: rgba(0,0,0,0.45); border-top: 1px solid rgba(255,255,255,0.12); border-bottom: 1px solid rgba(255,255,255,0.12); overflow:hidden; white-space:nowrap; }
    .ticker{ display:inline-block; padding-block:10px; will-change:transform; animation: ticker 28s linear infinite; }
    .ticker:hover{ animation-play-state: paused; }
    .ticker-item{ display:inline-block; margin-inline:26px; font-size: clamp(14px,1.6vw,18px); color:#ffeb3b; text-shadow: 0 0 8px rgba(255,235,59,.35); }
    @keyframes ticker { from{ transform: translateX(100%) } to{ transform: translateX(-100%) } }

    /* Footer المتحرك */
    .footer-ticker{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);border-top:1px solid rgba(255,255,255,.15);backdrop-filter:blur(6px);z-index:50;overflow:hidden;white-space:nowrap}
    .footer-ticker .inner{display:inline-block;padding:10px 0;animation:marquee 22s linear infinite;font-weight:800;color:#eafff8;text-shadow:0 0 10px rgba(25,209,184,.35)}
    .footer-ticker:hover .inner{animation-play-state:paused}
    @keyframes marquee{from{transform:translateX(100%)}to{transform:translateX(-100%)}}

    .bump{ animation: bump 260ms ease; } @keyframes bump{ 0%{ transform:scale(1); opacity:1 } 30%{ transform:scale(1.06); opacity:.92 } 100%{ transform:scale(1); opacity:1 } }
  </style>
</head>
<body>

  <div class="container-xl">
    <!-- Header -->
    <div class="admin-header">
      <div class="brand">
        <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" alt="شعار كلية الطب البيطري">
        <div>
          <h1>تتبُّع الدور — كلية الطب البيطري</h1>
          <small>ادارة شئون الطلاب</small>
        </div>
      </div>
    </div>

    <!-- خانة رقم الطالب -->
    <div class="cardx d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="title-muted">مرحبًا بكم</div>
      <div class="pill"><span class="label">رقمي</span><span id="myNum" class="value">—</span></div>
    </div>

    <!-- الرقم الجاري -->
    <div class="cardx text-center">
      <div class="title-muted mb-1">الرقم الجاري خدمته الآن</div>
      <div id="currentNumber" class="big-num">0</div>
    </div>

    <!-- المتبقي -->
    <div id="remainCard" class="cardx remain-card text-center">
      <div class="title-muted mb-1">المتبقي حتى رقمك</div>
      <div id="remaining" class="remain-num">—</div>
    </div>

    <!-- الإعلانات -->
    <div class="ticker-wrap">
      <div id="ticker" class="ticker">
        <span class="ticker-item">لا توجد إعلانات حالياً</span>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer-ticker">
    <div class="inner">
      &nbsp;&nbsp;تصميم مهندس بولس سمير — مدير وحدة تكنولوجيا المعلومات بكلية الطب البيطري جامعة المنيا&nbsp;&nbsp;•&nbsp;&nbsp;
      
    </div>
  </div>

  <!-- Firebase config -->
  <script src="js/firebase.js"></script>
  <script>
    // قراءة my من الرابط
    function getMyNumber(){
      const p = new URLSearchParams(location.search);
      const raw = (p.get('my') || '').trim();
      if (!raw) return null;
      const v = parseInt(raw, 10);
      return Number.isFinite(v) ? v : null;
    }
    const my = getMyNumber();
    document.getElementById('myNum').textContent = my ?? '—';

    const currentEl   = document.getElementById('currentNumber');
    const remainingEl = document.getElementById('remaining');
    const remainCard  = document.getElementById('remainCard');
    const tickerEl    = document.getElementById('ticker');

    let currentVal = 0, lastShownCurrent = null;
    let baseDuration = 28; // تُقرأ من الإعدادات

    function updateRemaining(){
      if (my == null) { remainingEl.textContent = '—'; remainCard.classList.remove('zero'); return; }
      const diff = Math.max(0, my - currentVal);
      remainingEl.textContent = diff;
      if (diff === 0) {
        if (!remainCard.classList.contains('zero')) {
          remainCard.classList.add('zero');
          remainCard.classList.remove('bump'); void remainCard.offsetWidth; remainCard.classList.add('bump');
        }
      } else { remainCard.classList.remove('zero'); }
    }

    // الرقم الجاري
    db.ref('queue/currentNumber').on('value', snap => {
      currentVal = Number(snap.val() || 0);
      currentEl.textContent = currentVal;
      if (lastShownCurrent !== null && lastShownCurrent !== currentVal) {
        currentEl.classList.remove('bump'); void currentEl.offsetWidth; currentEl.classList.add('bump');
      }
      lastShownCurrent = currentVal;
      updateRemaining();
    });

    // الإعلانات
    function renderTicker(items){
      if (!Array.isArray(items) || items.length === 0) items = ['لا توجد إعلانات حالياً'];
      tickerEl.innerHTML = '';
      items.forEach(t => { const span = document.createElement('span'); span.className='ticker-item'; span.textContent=t; tickerEl.appendChild(span); });
      const factor = Math.max(1, tickerEl.textContent.length / 120);
      tickerEl.style.animationDuration = (baseDuration * factor) + 's';
    }
    db.ref('announcements').on('value', snap => {
      const data = snap.val(); let items = [];
      if (Array.isArray(data)) items = data.filter(Boolean);
      else if (typeof data === 'string') items = data.split('|').map(s => s.trim()).filter(Boolean);
      else if (data && typeof data === 'object') items = Object.values(data).filter(Boolean);
      renderTicker(items);
    });

    // سرعة الشريط من الإعدادات (نفس مسار شاشة العرض)
    db.ref('settings/tickerBaseDuration').on('value', s => {
      baseDuration = Number(s.val() || 28);
      const txts = [...tickerEl.querySelectorAll('.ticker-item')].map(e=>e.textContent);
      renderTicker(txts);
    });
  </script>
</body>
</html>
