<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ - ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg1:#051a19; --bg2:#0f3f38;
      --ink:#fff; --muted:#dfeff0;
      --accent1:#ffeb3b; --accent2:#00e5ff; --accent3:#ff4081;
      --card:rgba(255,255,255,.08); --card-border:rgba(255,255,255,.16);
    }
    @keyframes bg-shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    body{
      margin:0; min-height:100vh; color:var(--ink);
      font-family:"Tajawal",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2)); background-size:200% 200%;
      animation:bg-shift 22s ease-in-out infinite; display:flex; flex-direction:column;
    }
    .container-xl{ max-width:1200px; padding-bottom:76px; flex:1 0 auto; }

    /* Header (Ø´Ø¹Ø§Ø± + Ø¹Ù†Ø§ÙˆÙŠÙ†) */
    .admin-header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:14px 0 6px;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{
      width:56px; height:56px; border-radius:12px; object-fit:cover; background:#fff;
      box-shadow:0 10px 26px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.25);
    }
    .brand h1{ margin:0; font-size:clamp(18px,2.2vw,26px); font-weight:900; text-shadow:0 8px 26px rgba(0,0,0,.25); }
    .brand small{ color:var(--muted); opacity:.9 }

    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ„ÙØ²ÙŠÙˆÙ†/Ø§Ù„Ø±Ù‚Ù… */
    .cardx{
      background:var(--card); border:1px solid var(--card-border); border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,.25); padding:16px;
    }
    .screen{position:relative; border-radius:16px; background:linear-gradient(135deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); padding:clamp(14px,3vw,28px); min-height:46vh;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; overflow:hidden}
    .blob{position:absolute; filter:blur(40px); opacity:.18; pointer-events:none; width:40vmax; height:40vmax; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, var(--accent2), transparent 60%); animation:float 20s ease-in-out infinite}
    .blob.b2{background:radial-gradient(circle at 70% 70%, var(--accent3), transparent 60%); animation-duration:26s; animation-delay:-4s}
    @keyframes float{0%,100%{transform:translate(-15%,-10%)}50%{transform:translate(10%,8%)}}

    #labelCurrent{font-size:clamp(16px,1.8vw,22px); opacity:.95}
    .number{position:relative; font-weight:900; line-height:.9; font-size:clamp(80px,18vw,220px); letter-spacing:-2px; text-align:center;
      background:conic-gradient(from var(--angle),#fff,var(--accent1),#fff,var(--accent2),#fff,var(--accent3),#fff);
      -webkit-background-clip:text; background-clip:text; color:transparent; animation:hueRotate 10s linear infinite; --angle:0deg}
    @keyframes hueRotate{0%{filter:hue-rotate(0deg);--angle:0deg}100%{filter:hue-rotate(360deg);--angle:360deg}}
    .number-glow{position:absolute; inset:0; z-index:-1; filter:blur(28px); opacity:.65; background:radial-gradient(ellipse at center, rgba(255,235,59,.45), rgba(0,229,255,.28), rgba(255,64,129,.25), transparent 60%); transform:scale(1.05); animation:glowPulse 2.4s ease-in-out infinite}
    @keyframes glowPulse{0%,100%{opacity:.55; transform:scale(1.03)}50%{opacity:.85; transform:scale(1.08)}}
    .bump{animation:bump 260ms ease} @keyframes bump{0%{transform:scale(1);opacity:1}30%{transform:scale(1.08);opacity:.92}100%{transform:scale(1);opacity:1}}

    /* Ø²Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… + Ø§Ù„ØªØ°ÙƒØ±Ø© */
    .cta-btn{display:inline-flex; align-items:center; gap:10px; padding:14px 18px; font-size:clamp(16px,2.2vw,22px); font-weight:800;
      border-radius:999px; background:linear-gradient(90deg,#ffee58,#ffd54f); color:#143; border:none; box-shadow:0 10px 28px rgba(0,0,0,.25), inset 0 -4px 0 rgba(0,0,0,.12); cursor:pointer}
    .ticket-card{position:relative; margin:12px auto 0; display:flex; gap:14px; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.14); border-radius:18px; padding:12px 14px; backdrop-filter:blur(6px)}
    .ticket-num{font-size:clamp(46px,8vw,110px); font-weight:900; line-height:.9; background:linear-gradient(45deg,#fff,#ffeb3b,#fff,#00e5ff,#fff); -webkit-background-clip:text; background-clip:text; color:transparent}
    .qr-holder{width:120px; height:120px; background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center}
    .ticket-text{font-size:clamp(14px,1.6vw,18px); opacity:.95}

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª */
    .ticker-wrap{width:100%; background:rgba(0,0,0,.45); border-top:1px solid rgba(255,255,255,.09); border-bottom:1px solid rgba(255,255,255,.09); overflow:hidden; white-space:nowrap}
    .ticker{display:inline-block; padding-block:10px; will-change:transform; animation:ticker 28s linear infinite}
    .ticker:hover{animation-play-state:paused}
    .ticker-item{display:inline-block; margin-inline:26px; font-size:clamp(14px,1.6vw,18px); color:#ffeb3b; text-shadow:0 0 8px rgba(255,235,59,.35)}
    @keyframes ticker{from{transform:translateX(100%)}to{transform:translateX(-100%)}}

    /* Footer Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
    .footer-ticker{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);border-top:1px solid rgba(255,255,255,.15);backdrop-filter:blur(6px);z-index:50;overflow:hidden;white-space:nowrap}
    .footer-ticker .inner{display:inline-block;padding:10px 0;animation:marquee 22s linear infinite;font-weight:800;color:#eafff8;text-shadow:0 0 10px rgba(25,209,184,.35)}
    .footer-ticker:hover .inner{animation-play-state:paused}
    @keyframes marquee{from{transform:translateX(100%)}to{transform:translateX(-100%)}}
  </style>
</head>
<body>

  <div class="container-xl">
    <!-- Header -->
    <div class="admin-header">
      <div class="brand">
        <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Ø´Ø¹Ø§Ø± ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ">
        <div>
          <h1>Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ â€” ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</h1>
          <small>Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù†ÙŠØ§ â€” Ù†Ø¸Ø§Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small>
        </div>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ù‚Ù… -->
    <div class="cardx">
      <div class="screen">
        <div class="blob"></div><div class="blob b2"></div>
        <div id="labelCurrent">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ø±ÙŠ Ø®Ø¯Ù…ØªÙ‡ Ø§Ù„Ø¢Ù†</div>
        <div style="position:relative; display:flex; align-items:center; justify-content:center;">
          <div aria-hidden="true" class="number-glow"></div>
          <div id="displayNumber" class="number">0</div>
        </div>
      </div>
    </div>

    <!-- Ø²Ø± Ø¥ØµØ¯Ø§Ø± Ø±Ù‚Ù… + Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© -->
    <div class="text-center mt-3">
      <button id="getTicketBtn" class="cta-btn">ğŸŸï¸ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="ticketCard" class="ticket-card" style="display:none; max-width:900px;">
      <div class="qr-holder"><div id="ticketQR"></div></div>
      <div class="ticket-text">
        <div>Ø±Ù‚Ù…Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±:</div>
        <div id="ticketNumber" class="ticket-num">â€”</div>
        <div class="mt-1"><small>Ø§Ù…Ø³Ø­ <b>QR</b> Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„ØªØªØ¨Ù‘ÙØ¹ Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ</small></div>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
    <div class="ticker-wrap mt-3">
      <div id="ticker" class="ticker">
        <span class="ticker-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</span>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer-ticker">
    <div class="inner">
      &nbsp;&nbsp;ØªØµÙ…ÙŠÙ… Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± â€” Ù…Ø¯ÙŠØ± ÙˆØ­Ø¯Ø© ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù†ÙŠØ§&nbsp;&nbsp;â€¢&nbsp;&nbsp;
      ØªØµÙ…ÙŠÙ… Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± â€” Ù…Ø¯ÙŠØ± ÙˆØ­Ø¯Ø© ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù†ÙŠØ§
    </div>
  </div>

  <!-- Firebase config -->
  <script src="js/firebase.js"></script>
  <script>
    const displayEl   = document.getElementById('displayNumber');
    const tickerEl    = document.getElementById('ticker');
    const getBtn      = document.getElementById('getTicketBtn');
    const ticketCard  = document.getElementById('ticketCard');
    const ticketNumEl = document.getElementById('ticketNumber');

    // ğŸ”— GitHub Pages Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const TRACK_BASE = 'https://boles2022.github.io/filestudent/track.html';

    let lastNumber   = null;
    let baseDuration = 28; // ØªÙÙ‚Ø±Ø£ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

    function animateNumber(){ displayEl.classList.remove('bump'); void displayEl.offsetWidth; displayEl.classList.add('bump'); }

    // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ø±ÙŠ
    db.ref('queue/currentNumber').on('value', snap => {
      const val = snap.val() ?? 0;
      if (val !== lastNumber) { displayEl.textContent = val; animateNumber(); lastNumber = val; }
    });

    // Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
    function renderTicker(items){
      if (!Array.isArray(items) || items.length === 0) items = ['Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹'];
      tickerEl.innerHTML = '';
      items.forEach(txt => {
        const span = document.createElement('span'); span.className = 'ticker-item'; span.textContent = txt; tickerEl.appendChild(span);
      });
      const factor = Math.max(1, tickerEl.textContent.length / 120);
      tickerEl.style.animationDuration = (baseDuration * factor) + 's';
    }
    db.ref('announcements').on('value', snap => {
      const data = snap.val(); let items = [];
      if (Array.isArray(data)) items = data.filter(Boolean);
      else if (typeof data === 'string') items = data.split('|').map(s => s.trim()).filter(Boolean);
      else if (data && typeof data === 'object') items = Object.values(data).filter(Boolean);
      renderTicker(items);
    });

    // Ø³Ø±Ø¹Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    db.ref('settings/tickerBaseDuration').on('value', s => {
      baseDuration = Number(s.val() || 28);
      const txts = [...tickerEl.querySelectorAll('.ticker-item')].map(e=>e.textContent);
      renderTicker(txts);
    });

    // Ø¥ØµØ¯Ø§Ø± Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯ + QR
    const issuedRef = db.ref('queue/lastIssuedNumber');
    getBtn.addEventListener('click', async () => {
      try {
        const newMyNumber = await issuedRef.transaction(curr => (Number(curr)||0) + 1)
          .then(res => { if (!res.committed) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥ØµØ¯Ø§Ø±'); return Number(res.snapshot.val() || 0); });

        ticketCard.style.display = '';
        ticketNumEl.textContent = newMyNumber;
        const trackUrl = TRACK_BASE + '?my=' + encodeURIComponent(newMyNumber);
        document.getElementById('ticketQR').innerHTML = '';
        new QRCode(document.getElementById('ticketQR'), { text: trackUrl, width: 112, height: 112, correctLevel: QRCode.CorrectLevel.M });
      } catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø¥ØµØ¯Ø§Ø± Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø¢Ù†. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); }
    });
  </script>
</body>
</html>
